name: Build, Release, Deploy

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Login to Yandex Registry
        uses: docker/login-action@v3
        with:
          registry: cr.yandex
          username: oauth
          password: ${{ secrets.YC_TOKEN }}
      - name: Build and push Docker image with :latest tag
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: cr.yandex/${{ vars.YC_REGISTRY }}/${{ vars.APP_IMAGE_NAME }}:latest

  release:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 
      - uses: actions/setup-node@v4
        with:
          node-version: '22.8'
      - name: Install Dependencies
        run: npm install semantic-release @semantic-release/commit-analyzer @semantic-release/release-notes-generator @semantic-release/exec @semantic-release/github
      - name: Create .releaserc
        run: |
          echo '{
            "branches": ["main"],
            "plugins": [
              "@semantic-release/commit-analyzer",
              "@semantic-release/release-notes-generator",
              "@semantic-release/github"
            ]
          }' > .releaserc
      - name: Run semantic-release
        run: npx semantic-release --ci
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Set version output
        id: version
        run: |
          VERSION=$(git describe --tags --abbrev=0)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

  deploy:
    runs-on: ubuntu-latest
    needs: release
    environment: production
    steps:
      - uses: actions/checkout@v4
      - name: Fetch secrets from Yandex Lockbox
        id: lockbox
        uses: yc-actions/yc-lockbox@v2.0.0
        with:
          yc-sa-json-credentials: ${{ secrets.YC_SA_JSON_CREDENTIALS }}
          secret-id: ${{ vars.YC_LOCKBOX_SECRET_ID }}
      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | base64 -d > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ vars.SERVER_IP }} >> ~/.ssh/known_hosts
      - name: Deploy to server
        run: |
          cat <<'EOF' | ssh -o StrictHostKeyChecking=yes root@${{ vars.SERVER_IP }} bash -s
          set -euo pipefail
          cd /root/beyondsecure
          echo '${{ secrets.YC_TOKEN }}' | docker login --username oauth --password-stdin cr.yandex
          echo "TG_TOKEN=${{ steps.lockbox.outputs.TG_TOKEN }}" > .env
          echo "POSTGRES_PASSWORD=zoW6rZF274ufQHtJMhdCMbBoICv6KGWG" >> .env
          chmod 600 .env
          docker compose pull
          docker compose --env-file .env up -d --remove-orphans
          docker image prune -af --filter "until=24h"
          EOF